<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gold Price Visualization</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.3.3/dist/echarts.js"
        integrity="sha256-E5b0O4AhPTlxRxD4SNUVrMx7/RQDnV2PjWpPIjWoXd4=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"
        integrity="sha512-dfX5uYVXzyU8+KHqj8bjo7UkOdg18PaOtpa48djpNbZHwExddghZ+ZmzWT06R5v6NSk3ZUfsH6FNEDepLx9hPQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        /* Chrome, Safari, Edge, Opera */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Firefox */
        input[type=number] {
            -moz-appearance: textfield;
        }

        tr {
            vertical-align: middle;
        }

        tr>td:first-child {
            text-align: center;
        }
        
        td {
            background-color: transparent !important;
        }

        .container {
            min-height: 88vh;
        }

        @media (max-width: 576px) {

            html,
            body {
                margin: 0;
                height: 100%;
                overflow: hidden
            }

            .container {
                min-height: 70vh;
            }
        }
    </style>
</head>

<body>
    <template id="tr-lg">
        <tr id="">
            <td><input type="checkbox" id="check-" class="form-check-input" /></td>
            <!-- TODO L4: disable future date -->
            <td><input type="date" id="date-" class="form-control" /></td>
            <td><input type="number" id="buy-" class="form-control" min="0" /></td>
            <td><input type="number" id="sell-" class="form-control" min="0" /></td>
            <td>
                <input type="number" id="price-" class="form-control" step="0.01"/>
                <datalist id="list-"></datalist>
            </td>
            <td><input type="number" id="rm-" class="form-control-plaintext text-center" readonly /></td>
        </tr>
    </template>
    <div class="container position-relative">
        <ul class="pt-3 nav nav-tabs d-lg-flex d-none">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#basic_chart" type="button"
                    role="tab">Gold Savings Account</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#premium_chart" type="button"
                    role="tab">Premier Gold Account</button>
            </li>
            <li class="ms-auto">
                <button class="btn btn-primary mx-auto" data-bs-toggle="modal" data-bs-target="#trx-data" type="button"
                    role="tab">☰</button>
            </li>
        </ul>
        <ul class="pt-3 nav nav-pills d-flex d-lg-none row">
            <li class="nav-item col">
                <button class="nav-link mx-auto active" data-bs-toggle="tab" data-bs-target="#basic_chart" type="button"
                    role="tab">Gold Savings Account</button>
            </li>
            <li class="nav-item col">
                <button class="nav-link mx-auto" data-bs-toggle="tab" data-bs-target="#premium_chart" type="button"
                    role="tab">Premier Gold Account</button>
            </li>
            <li class="col-1">
                <button id="btn-trx-data" class="btn btn-primary mx-auto" data-bs-toggle="modal" data-bs-target="#trx-data"
                    type="button" role="tab">☰</button>
            </li>
        </ul>
        <div class="tab-content mt-4">
            <div id="basic_chart" class="tab-pane fade position-absolute w-100 h-100 show active" role="tabpanel"
                tabindex="0"></div>
            <div id="premium_chart" class="tab-pane fade position-absolute w-100 h-100" role="tabpanel" tabindex="0">
            </div>
        </div>
        <div id="trx-data" class="modal fade" tabindex="-1">
            <form id="form" class="modal-dialog modal-lg modal-dialog-scrollable modal-fullscreen-lg-down" novalidate>
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5">Gold Transaction Data</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <table class="table ">
                            <!-- TODO L5: Show non-editable table in small screen -->
                            <thead>
                                <tr style="text-align: center; user-select: none;">
                                    <th scope="col"><input type="checkbox" id="header-check" class="form-check-input" /></th>
                                    <th scope="col" id="header-date">Date</th>
                                    <th scope="col" id="header-buy">Buy</th>
                                    <th scope="col" id="header-sell">Sell</th>
                                    <th scope="col" id="header-price">Price/unit</th>
                                    <th scope="col" id="header-rm">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                            <tfoot>
                                <tr id="tr-total">
                                    <th colspan="5" style="text-align: right;">Total</th>
                                    <th><input type="number" id="total" class="form-control-plaintext text-center" value="0.00" readonly /></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <div class="modal-footer justify-content-between d-flex">
                        <button id="btn-add" type="button" class="btn btn-primary">Add</button>
                        <!-- TODO L5: add bulk button -->
                        <!-- <button type="button" class="btn btn-primary">Add Bulk</button> -->
                        <div>
                            <input id="btn-sell" type="checkbox" class="btn-check" autocomplete="off">
                            <label id="lb-sell" class="btn btn-outline-primary" for="btn-sell">Sell All Now!</label>
                        </div>
                        <button id="btn-remove" type="button" class="btn btn-primary">Remove</button>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save changes</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script type="text/javascript">
        let gold_history = JSON.parse(localStorage.getItem('gold_history'))
        if (!gold_history) {
            gold_history = []
        }
        let gold_settings = JSON.parse(localStorage.getItem('gold_settings'))
        if (!gold_settings) {
            gold_settings = {
                'sell-all': false
            }
        }
        function calculate_bal() {
            const buy = document.querySelectorAll('tbody input[id^="buy"]')
            const sell = document.querySelectorAll('tbody input[id^="sell"]')
            let bal = 0
            for (const b of buy) {
                const num = b.id.match(/\d+/g)
                if (document.querySelector(`#rm-${num}`).value !== "0.00") {
                    bal += Number(b.value)
                }
            }
            for (const s of sell) {
                const num = s.id.match(/\d+/g)
                if (document.querySelector(`#rm-${num}`).value !== "0.00") {
                    bal -= Number(s.value)
                }
            }
            return bal
        }
        function save_item(item, name) {
            localStorage.setItem(name, JSON.stringify(item))
        }
        function find_active_chart() {
            return document.querySelector('#basic_chart').classList.contains('active') ? 'data/basic_price.csv' : 'data/premium_price.csv'
        }
        function build_tr(row, disabled=false) {
            const tr = document.querySelector('#tr-lg').cloneNode(true).content.firstElementChild
            const last_tr = document.querySelector('tbody').lastElementChild
            const num = disabled ? 0 
                : last_tr ? Number(last_tr.id) + 1 
                : 1
            tr.id = num
            const check = tr.querySelector('#check-')
            const date = tr.querySelector('#date-')
            const buy = tr.querySelector('#buy-')
            const sell = tr.querySelector('#sell-')
            const price = tr.querySelector('#price-')
            const rm = tr.querySelector('#rm-')
            if (row) {
                date.value = row['date']
                if(row['unit'] > 0) {
                    buy.value = row['unit']
                    sell.setAttribute('disabled', true)
                    tr.style.backgroundColor = '#b5dab5'
                } else {
                    sell.value = -row['unit']
                    buy.setAttribute('disabled', true)
                    tr.style.backgroundColor = '#ffcccc'
                }
                price.value = set_decimal(row['price'])
            }
            if (disabled) {
                // TODO L3: support on sell partial unit now
                check.hidden = true;
                [date, buy, sell, price].forEach(elem => {
                    elem.setAttribute('disabled', true)
                    elem.setAttribute('readonly', true)
                })
            } else {
                check.checked = document.querySelector('#header-check').checked
            }
            price.setAttribute('list', `list-${num}`)
            buy.addEventListener('keyup', event => {
                rm_value = - price.value * buy.value
                rm.value = set_decimal(rm_value)
                calculate_total()
                if (buy.value !== "") {
                    sell.value = ""
                    sell.setAttribute('disabled', true)
                    tr.style.backgroundColor = '#b5dab5'
                } else {
                    sell.removeAttribute('disabled')
                    tr.style.backgroundColor = ''
                }
            })
            sell.addEventListener('keyup', event => {
                rm_value = price.value * sell.value
                rm.value = set_decimal(rm_value)
                calculate_total()
                if (sell.value !== "") {
                    buy.value = ""
                    buy.setAttribute('disabled', true)
                    tr.style.backgroundColor = '#ffcccc'
                } else {
                    buy.removeAttribute('disabled')
                    tr.style.backgroundColor = ''
                }
            })
            price.addEventListener('keyup', event => {
                rm_value = price.value * (sell.value - buy.value)
                rm.value = set_decimal(rm_value)
                calculate_total()
            })
            price.addEventListener('focus', event => {
                if (date.value !== "") {
                    const address = find_active_chart();
                    const regex = new RegExp(date.value, 'i')
                    tr.querySelectorAll('option').forEach(el => el.remove())
                    load_data(address)
                        .then(data => {
                            for (const history of data.filter(row => regex.test(row[0]))) {
                                if (buy.value !== '') {
                                    const opt_value = set_decimal(Number(history[1]))
                                    const option = new Option(opt_value, opt_value)
                                    tr.querySelector('datalist').appendChild(option)
                                } else if (sell.value !== '') {
                                    const opt_value = set_decimal(Number(history[2]))
                                    const option = new Option(opt_value, opt_value)
                                    tr.querySelector('datalist').appendChild(option)
                                }
                            }
                        })
                }
            })
            tr.querySelectorAll('[id$="-"]').forEach(elem => elem.id += num)
            calculate_subtotal(tr)
            return tr
        }
        function set_decimal(num) {
            return Math.abs(num) > 99999 ? num.toFixed(0) : num.toFixed(2)
        }
        function calculate_total() {
            if (document.querySelector('#btn-sell').checked) {
                const bal = calculate_bal()
                const tr = document.querySelector('tfoot>tr:not([id="tr-total"])')
                const buy = tr.querySelector('input[id^="buy"]')
                const sell = tr.querySelector('input[id^="sell"]')
                const price = tr.querySelector('input[id^="price"]')
                const rm = tr.querySelector('input[id^="rm"]')
                if (bal > 0) {
                    sell.value = bal
                    buy.value = ""
                } else if (bal < 0) {
                    buy.value = -bal
                    sell.value = ""
                } else {
                    buy.value = ""
                    sell.value = ""
                }
                rm.value = set_decimal(price.value * (sell.value - buy.value))
            }
            let total = 0
            for (const subtotal of document.querySelectorAll('input[id^="rm-"]')) {
                total += Number(subtotal.value)
            }
            document.querySelector('#total').value = set_decimal(total)
        }
        function calculate_subtotal(elem) {
            const date = elem.querySelector('input[id^="date"]')
            const buy = elem.querySelector('input[id^="buy"]')
            const sell = elem.querySelector('input[id^="sell"]')
            const price = elem.querySelector('input[id^="price"]')
            const rm = elem.querySelector('input[id^="rm"]')
            let rm_value = price.value * (sell.value - buy.value)
            rm.value = set_decimal(rm_value)
        }
        window.onload = () => {
            document.querySelector('#header-check').addEventListener('change', event => {
                document.querySelectorAll('tbody input[id^="check-"]').forEach(elem => {
                    elem.checked = event.target.checked
                })
            })
            // Add listener on table header
            function sort_content(target, subject) {
                const regex = new RegExp('▲$', 'i')
                let title = target.textContent
                const is_dsc = regex.test(title);
                [...document.querySelectorAll('tbody>tr')]
                    .sort((a,b) => {
                        const is_date = event.target.id.includes('date')
                        let a_val = a.querySelector(`input[id^=${subject}]`).value
                        let b_val = b.querySelector(`input[id^=${subject}]`).value
                        const a_val_empty = is_date ? a_val==='' : !a_val
                        const b_val_empty = is_date ? b_val==='' : !b_val
                        if (a_val_empty) {
                            return 1
                        } else if (b_val_empty) {
                            return -1
                        } else {
                            a_val = is_date ? new Date(a_val) : parseFloat(a_val)
                            b_val = is_date ? new Date(b_val) : parseFloat(b_val)
                            // if (is_dsc) {
                            //     return a_val > b_val ? -1 : 1
                            // } else {
                            //     return a_val < b_val ? -1 : 1
                            // }
                            return (is_dsc ^ (a_val > b_val)) ? 1 : -1
                        }
                    })
                    .forEach(tr => document.querySelector('tbody').appendChild(tr))
                document
                    .querySelectorAll('th[id^="header"]')
                    .forEach(elem => elem.textContent = elem.textContent.replace(/▼|▲/g, ''))
                target.textContent += (is_dsc ? '▼' : '▲')
                gold_settings['sort'] = subject
                gold_settings['is_dsc'] = is_dsc
                save_item(gold_settings, 'gold_settings')
            }
            document.querySelectorAll('th[id^="header"]').forEach(elem => {
                const subject = elem.id.replace('header-', '')
                elem.addEventListener('click', event => sort_content(elem, subject))
            })
            document.querySelector('#btn-add').addEventListener('click', event => {
                const tr = build_tr()
                document.querySelector('tbody').append(tr)
            })
            document.querySelector('#btn-remove').addEventListener('click', event => {
                document.querySelectorAll('input[id^="check-"]:checked').forEach(elem => {
                    elem.closest('tr').remove()
                    calculate_total()
                })
            })
            document.querySelector('#btn-sell').addEventListener('change', event => {
                const bal = calculate_bal()
                if (event.target.checked) {
                    const address = find_active_chart();
                    if (bal != 0) {
                        load_data(address)
                            .then(data => {
                                const row = {
                                    'date': (new Date).toISOString().slice(0,10),
                                    'unit': -bal,
                                    'price': bal > 0 ? Number(data.at(-1)[2]):Number(data.at(-1)[1]),
                                }
                                const tr = build_tr(row, true)
                                document.querySelector('tfoot').prepend(tr)
                                calculate_total()
                            })
                    } else {
                        document.querySelector('#btn-sell').checked = false
                    }
                } else {
                    const tr = document.querySelector('tfoot>tr:not([id="tr-total"])')
                    if (tr) {
                        tr.remove()
                        calculate_total()
                    }
                }
                gold_settings['sell-all'] = bal!=0 && event.target.checked
                save_item(gold_settings, 'gold_settings')
            })
            document.querySelector('#form').addEventListener('submit', event => {
                event.preventDefault();
                function is_empty(elem) {
                    return elem.value == 0 && !elem.getAttribute('disabled')
                }
                document.querySelectorAll('input[id^="buy"],input[id^="sell"]').forEach(elem => {
                    elem.classList.remove('is-invalid')
                    if (!Number.isInteger(Number(elem.value)) || is_empty(elem)) {
                        elem.classList.add('is-invalid')
                    }
                })
                document.querySelectorAll('input[id^="price"]').forEach(elem => {
                    elem.classList.remove('is-invalid')
                    if (is_empty(elem)) {
                        elem.classList.add('is-invalid')
                    }
                })
                document.querySelectorAll('input[id^="date"]').forEach(elem => {
                    elem.classList.remove('is-invalid')
                    if (!elem.value) {
                        elem.classList.add('is-invalid')
                    }
                })
                if (document.querySelectorAll('.is-invalid').length == 0) {
                    gold_history = []
                    document.querySelectorAll('tbody tr').forEach(elem => {
                        gold_history.push({
                            'date': elem.querySelector('input[id^="date"]').value,
                            'unit': Number(elem.querySelector('input[id^="buy"]').value) - Number(elem.querySelector('input[id^="sell"]').value),
                            'price': Number(elem.querySelector('input[id^="price"]').value)
                        })
                    })
                    save_item('gold_history', gold_history)
                    render_charts()
                    bootstrap.Modal.getInstance(document.querySelector('#trx-data')).hide()
                }
            })
            document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(
                tabEl => tabEl.addEventListener('shown.bs.tab', event => {
                    event.target.textContent == 'Premier Gold Account' ? premium_chart.resize() : basic_chart.resize()
                })
            )
            document.querySelector('#btn-trx-data').click()
            for (const row of gold_history) {
                const tr = build_tr(row)
                calculate_subtotal(tr)
                document.querySelector('tbody').append(tr)
            }
            calculate_total()
            // Click on btn-sell if gold_settings['sell-all'] == true
            if (gold_settings['sell-all']) {
                document.querySelector('#btn-sell').click()
            }
            if (gold_settings['sort']) {
                const header = document.querySelector(`#header-${gold_settings['sort']}`)
                const is_dsc = gold_settings['is_dsc']
                header.click()
                if (is_dsc) {
                    header.click()
                }
            }
            render_charts()
        }
    </script>

    <script type="text/javascript">
        const basic_chart = echarts.init(document.getElementById('basic_chart'));
        const premium_chart = echarts.init(document.getElementById('premium_chart'));

        let option = {
            title: {
                text: ''
            },
            tooltip: {
                trigger: 'axis'
            },
            legend: {},
            xAxis: {
                type: 'time',
            },
            yAxis: {
                type: 'value',
                min: 'dataMin'
            },
            dataZoom: [
                {
                    type: 'slider',
                    show: true,
                    xAxisIndex: [0],
                }
            ],
            dataset: {
                source: []
            },
            series: [
                {
                    name: 'Bank Selling',
                    type: 'line',
                    step: 'end',
                    showSymbol: false,
                    endLabel: {
                        show: true,
                        formatter: (params) => {
                            return parseFloat(params.value[1]).toFixed(2)
                        }
                    },
                    encode: {
                        x: 'TIME',
                        y: 'SELLING',
                    },
                    markPoint: {
                        data: [],
                        label: {}
                    }
                }, {
                    name: 'Bank Buying',
                    type: 'line',
                    step: 'end',
                    showSymbol: false,
                    endLabel: {
                        show: true,
                        formatter: (params) => {
                            return parseFloat(params.value[2]).toFixed(2)
                        }
                    },
                    encode: {
                        x: 'TIME',
                        y: 'BUYING',
                    },
                    markPoint: {
                        data: [],
                        label: {}
                    }
                }
            ]
        };
        let cache = {}
        let fetch_promise = {}
        function load_data(url) {
            if (cache[url]) {
                // console.log('cache')
                return Promise.resolve(cache[url]);
            } else if (fetch_promise[url]) {
                // console.log('waiting')
                return fetch_promise[url]
            } else {
                // console.log('not cache')
                fetch_promise[url] = fetch(url)
                    .then(res => res.text())
                    .then(data => {
                        cache[url] = Papa.parse(data, { skipEmptyLines: true }).data.map(row => Object.values(row));
                        return cache[url];
                    })
                    .catch(error => console.error(error))
                    .finally(() => fetch_promise[url] = null)
                return fetch_promise[url]
            }
        }

        function render_chart(title, data, chart) {
            option.dataset.source = data;
            const date = new Date();
            let newData = [...data.slice(-1)[0]]
            newData[0] = string_date(date)
            data.push(newData)
            if (document.body.clientWidth < 597) {
                option.grid = {
                    right: '20%',
                    left: '15%',
                }
                option.series.forEach(s => {
                    s.markPoint.symbolSize = 30
                    s.markPoint.label.fontSize = 9
                })
                date.setDate(1)
                date.setMonth(date.getMonth() - 3)
                option.dataZoom[0].startValue = string_date(date)
            } else {
                date.setMonth(date.getMonth() - 6)
                option.dataZoom[0].startValue = string_date(date)
            }
            const mark_point_buy = []
            const mark_point_sell = []
            for (const trx of gold_history) {
                const regex = RegExp(trx['date'], 'i')
                const is_buy = trx['unit'] > 0
                const dates = data.filter(row => regex.test(row[0]) && (is_buy?row[1]:row[2])==trx['price'])
                let trx_date;
                if (dates.length > 0) {
                    trx_date = dates[0][0]
                } else if ((trx['price'] <= 99999 && title.includes('Savings')) || (trx['price'] > 99999 && title.includes('Premier'))) {
                    trx_date = trx['date']
                }
                if (trx_date) {
                    if(is_buy) {
                        const d = {
                            value: trx['unit'],
                            xAxis: trx_date,
                            yAxis: trx['price']
                        }
                        mark_point_buy.push(d)
                    } else {
                        const d = {
                            value: -trx['unit'],
                            xAxis: trx_date,
                            yAxis: trx['price']
                        }
                        mark_point_sell.push(d)
                    }
                }
            }
            option['series'][0]['markPoint']['data'] = mark_point_buy
            option['series'][1]['markPoint']['data'] = mark_point_sell
            chart.setOption(option);
        }

        function string_date(date) {
            const year = `${date.getFullYear()}`
            const month = `${(date.getMonth() + 1).toString().padStart(2, '0')}`
            const day = `${date.getDate().toString().padStart(2, '0')}`
            const hour = `${date.getHours().toString().padStart(2, '0')}`
            const minute = `${date.getMinutes().toString().padStart(2, '0')}`
            const second = `${date.getSeconds().toString().padStart(2, '0')}`
            return `${year}-${month}-${day} ${hour}:${minute}:${second}`;
        }

        function render_charts() {
            Promise.all([load_data('data/basic_price.csv'), load_data('data/premium_price.csv')])
                .then(([basic_data, premium_data]) => {
                    render_chart('Gold Savings Account', basic_data, basic_chart)
                    render_chart('Premier Gold Account', premium_data, premium_chart)
                })
        }

        window.onresize = () => {
            basic_chart.resize()
            premium_chart.resize()
        }

        // const sleep = ms => new Promise(r => setTimeout(r, ms));
        // (async function demo() {
        //     for (let i = 0; i < 5; i++) {
        //         console.log(`Waiting ${i} seconds...`);
        //         await sleep(i * 1000);
        //         load_basic_data('data/basic_price.csv')
        //         load_basic_data('data/premium_price.csv')
        //     }
        //     console.log('Done');
        // })()
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
        crossorigin="anonymous"></script>
</body>

</html>